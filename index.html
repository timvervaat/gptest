<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Financiële planningstool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- React + ReactDOM (CDN, GitHub Pages proof) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/*
────────────────────────────────────────────────
STAP 1 — NL BELASTING (vereenvoudigd)
────────────────────────────────────────────────
*/
function calculateIncomeTaxNL(yearlyIncome, householdType = 'single') {
  const income = householdType === 'fiscal-partner'
    ? yearlyIncome * 2
    : yearlyIncome;

  let tax;
  if (income <= 73031) tax = income * 0.3693;
  else tax = 73031 * 0.3693 + (income - 73031) * 0.495;

  // Heffingskortingen (indicatief)
  let general = Math.max(0, 3070 - Math.max(0, income - 22660) * 0.06095);
  let labor = Math.max(0, 5052 - Math.max(0, income - 37691) * 0.0651);

  return Math.max(0, tax - general - labor);
}

/*
────────────────────────────────────────────────
STAP 2 — TOESLAGEN (vereenvoudigd)
────────────────────────────────────────────────
*/
function calculateToeslagen({ yearlyIncome, childrenCount, householdType }) {
  if (childrenCount === 0) return 0;
  const income = householdType === 'fiscal-partner' ? yearlyIncome * 2 : yearlyIncome;

  let total = childrenCount * 1200; // kinderbijslag
  const threshold = householdType === 'fiscal-partner' ? 40000 : 30000;

  if (income < threshold) total += childrenCount * 2500;
  else if (income < threshold + 20000) {
    total += childrenCount * 2500 * (1 - (income - threshold) / 20000);
  }
  return Math.max(0, total);
}

/*
────────────────────────────────────────────────
STAP 3 — FINANCIAL ENGINE
────────────────────────────────────────────────
*/
function calculateAnnualCashflow(year, incomes, expenses, assumptions, householdType) {
  const grossIncome = incomes.reduce((sum, i) => {
    const growth = Math.pow(1 + (i.growthRate || 0) / 100, year - i.startYear);
    const base = i.frequency === 'monthly' ? i.amount * 12 : i.amount;
    return sum + base * growth;
  }, 0);

  const tax = calculateIncomeTaxNL(grossIncome, householdType);
  const toeslagen = calculateToeslagen({ yearlyIncome: grossIncome, childrenCount: assumptions.childrenCount, householdType });

  const expensesTotal = expenses.reduce((sum, e) => {
    const inflation = e.adjustForInflation ? Math.pow(1 + assumptions.inflationRate / 100, year - e.startYear) : 1;
    const base = e.frequency === 'monthly' ? e.amount * 12 : e.amount;
    return sum + base * inflation;
  }, 0);

  const netIncome = grossIncome - tax + toeslagen;

  return {
    grossIncome,
    tax,
    toeslagen,
    expenses: expensesTotal,
    income: netIncome,
    savings: netIncome - expensesTotal
  };
}

function projectNetWorth({ startYear, years, startNetWorth, incomes, expenses, assumptions, householdType }) {
  let netWorth = startNetWorth;
  const timeline = [];

  for (let y = startYear; y < startYear + years; y++) {
    const cashflow = calculateAnnualCashflow(y, incomes, expenses, assumptions, householdType);
    netWorth = netWorth * (1 + assumptions.investmentReturn / 100) + cashflow.savings;

    timeline.push({ year: y, cashflow, netWorth });
  }
  return timeline;
}

/*
────────────────────────────────────────────────
STAP 4 — FIRE & KPI's
────────────────────────────────────────────────
*/
function findFireYear(timeline, target) {
  const hit = timeline.find(y => y.netWorth >= target);
  return hit ? hit.year : null;
}

function monthlySavingsFromCashflow(cf) {
  return cf.savings / 12;
}

function calculateFireTargetFromExpenses(expenses, swr) {
  const yearly = expenses.reduce((s, e) => s + (e.frequency === 'monthly' ? e.amount * 12 : e.amount), 0);
  return yearly / (swr / 100);
}

/*
────────────────────────────────────────────────
STAP 5 — SVG CHART
────────────────────────────────────────────────
*/
function NetWorthChart({ timeline, target }) {
  if (!timeline.length) return null;
  const w = 600, h = 200, p = 30;
  const max = Math.max(target, ...timeline.map(t => t.netWorth));

  const pts = timeline.map((t, i) => {
    const x = p + (i / (timeline.length - 1)) * (w - p * 2);
    const y = h - p - (t.netWorth / max) * (h - p * 2);
    return `${x},${y}`;
  }).join(' ');

  return (
    <svg viewBox={`0 0 ${w} ${h}`} className="w-full bg-white border rounded">
      <polyline fill="none" stroke="#3b82f6" strokeWidth="3" points={pts} />
    </svg>
  );
}

/*
────────────────────────────────────────────────
APP
────────────────────────────────────────────────
*/
function App() {
  const startYear = new Date().getFullYear();

  const [householdType, setHouseholdType] = useState('single');
  const [childrenCount, setChildrenCount] = useState(0);

  const [incomes] = useState([
    { id: 1, amount: 80000, frequency: 'yearly', growthRate: 2, startYear }
  ]);

  const [expenses] = useState([
    { id: 1, amount: 2500, frequency: 'monthly', startYear, adjustForInflation: true }
  ]);

  const [assumptions] = useState({ inflationRate: 2, investmentReturn: 7, safeWithdrawalRate: 4, childrenCount });
  const [netWorth] = useState(20000);

  const fireTarget = calculateFireTargetFromExpenses(expenses, assumptions.safeWithdrawalRate);

  const timeline = projectNetWorth({
    startYear,
    years: 50,
    startNetWorth: netWorth,
    incomes,
    expenses,
    assumptions: { ...assumptions, childrenCount },
    householdType
  });

  const fireYear = findFireYear(timeline, fireTarget);

  return (
    <div className="max-w-4xl mx-auto p-6 space-y-6">
      <h1 className="text-2xl font-bold">Financiële planningstool</h1>

      <div className="bg-white p-4 rounded shadow space-y-2">
        <label>Huishouden</label>
        <select value={householdType} onChange={e => setHouseholdType(e.target.value)} className="border p-1">
          <option value="single">Single</option>
          <option value="fiscal-partner">Fiscaal partner</option>
        </select>

        <label>Aantal kinderen</label>
        <input type="number" min="0" value={childrenCount} onChange={e => setChildrenCount(+e.target.value || 0)} className="border p-1" />
      </div>

      <div className="bg-white p-4 rounded shadow">
        <p><strong>FIRE-doel:</strong> €{Math.round(fireTarget).toLocaleString()}</p>
        <p><strong>FIRE-jaar:</strong> {fireYear ?? 'niet binnen 50 jaar'}</p>
      </div>

      <NetWorthChart timeline={timeline} target={fireTarget} />
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
