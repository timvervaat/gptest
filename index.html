<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Financiële planningstool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- React (CDN) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* =====================================================
   STAP 1 — FINANCIAL ENGINE
===================================================== */

function calculateHouseholdIncome(incomes, year, householdType) {
  return incomes
    .filter(i =>
      year >= i.startYear &&
      (!i.endYear || year <= i.endYear) &&
      (householdType === 'fiscal-partner' || i.person === 'you')
    )
    .reduce((sum, i) => {
      const growth = i.growthRate
        ? Math.pow(1 + i.growthRate / 100, year - i.startYear)
        : 1;
      const base = i.frequency === 'monthly' ? i.amount * 12 : i.amount;
      return sum + base * growth;
    }, 0);
}

function calculateMortgageAnnualCost(mortgage, year) {
  if (!mortgage || year < mortgage.startYear) return { payment: 0, interest: 0 };

  const r = mortgage.interestRate / 100;
  const P = mortgage.principal;
  const n = mortgage.durationYears;

  if (mortgage.mortgageType === 'interest-only') {
    const interest = P * r;
    return { payment: interest, interest };
  }

  const annuity = P * (r / (1 - Math.pow(1 + r, -n)));
  const interest = P * r;

  return { payment: annuity, interest };
}

function calculateAnnualCashflow(
  year,
  incomes,
  expenses,
  assumptions,
  mortgage,
  householdType
) {
  const income = calculateHouseholdIncome(incomes, year, householdType);

  let expensesTotal = 0;
  expenses.forEach(e => {
    if (year < e.startYear || (e.endYear && year > e.endYear)) return;
    const inflation = e.adjustForInflation
      ? Math.pow(1 + assumptions.inflationRate / 100, year - e.startYear)
      : 1;
    const base = e.frequency === 'monthly' ? e.amount * 12 : e.amount;
    expensesTotal += base * inflation;
  });

  let deductibleInterest = 0;
  if (mortgage) {
    const { payment, interest } = calculateMortgageAnnualCost(mortgage, year);
    expensesTotal += payment;
    deductibleInterest = interest;
  }

  return {
    income,
    expenses: expensesTotal,
    savings: income - expensesTotal,
    deductibleInterest
  };
}

/* =====================================================
   STAP 7 — NL INKOMSTENBELASTING
===================================================== */

function calculateNLIncomeTax({ income }) {
  let tax = 0;
  if (income <= 73000) tax = income * 0.3693;
  else tax = 73000 * 0.3693 + (income - 73000) * 0.495;
  return tax;
}

function calculateHouseholdTax({ incomes, year, householdType, deductibleInterest }) {
  const active = incomes.filter(i =>
    year >= i.startYear &&
    (!i.endYear || year <= i.endYear) &&
    (householdType === 'fiscal-partner' || i.person === 'you')
  );

  let remainingDeduction = deductibleInterest || 0;
  let totalTax = 0;

  active
    .sort((a, b) => b.amount - a.amount)
    .forEach(i => {
      const base = i.frequency === 'monthly' ? i.amount * 12 : i.amount;
      const deduction = Math.min(base, remainingDeduction);
      remainingDeduction -= deduction;
      const taxable = Math.max(0, base - deduction);
      totalTax += calculateNLIncomeTax({ income: taxable });
    });

  return totalTax;
}

/* =====================================================
   STAP 8a / 8b — TOESLAGEN
===================================================== */

function calculateNLBenefits({ income, householdType, childrenCount }) {
  let total = 0;
  if (householdType === 'single' && income < 38000) total += 1500;
  if (householdType === 'fiscal-partner' && income < 50000) total += 2500;

  if (childrenCount > 0) {
    const base = 1200 * childrenCount;
    const penalty = Math.max(0, (income - 30000) * 0.05);
    total += Math.max(0, base - penalty);
  }
  return total;
}

function calculateChildcareBenefit({ income, children }) {
  const caps = { dagopvang: 9.65, bso: 8.12, gastouder: 7.02 };
  const rate =
    income < 30000 ? 0.9 :
    income < 50000 ? 0.7 :
    income < 70000 ? 0.4 : 0;

  return children.reduce((sum, c) => {
    if (!c.childcareHours) return sum;
    return sum + c.childcareHours * caps[c.childcareType] * rate * 12;
  }, 0);
}

/* =====================================================
   STAP 4 — SVG GRAFIEK
===================================================== */

function NetWorthChart({ timeline, target }) {
  if (!timeline) return null;
  const w = 600, h = 200, p = 30;
  const max = Math.max(target, ...timeline.map(y => y.netWorth));

  const points = timeline.map((y, i) => {
    const x = p + (i / (timeline.length - 1)) * (w - p * 2);
    const yPos = h - p - (y.netWorth / max) * (h - p * 2);
    return `${x},${yPos}`;
  }).join(' ');

  return (
    <svg viewBox={`0 0 ${w} ${h}`} className="w-full bg-white rounded border">
      <polyline fill="none" stroke="#3b82f6" strokeWidth="3" points={points} />
    </svg>
  );
}

/* =====================================================
   APP
===================================================== */

function App() {
  const [householdType, setHouseholdType] = useState('single');

  const incomes = [
    { id: 1, person: 'you', amount: 80000, frequency: 'yearly', growthRate: 2, startYear: 2026 },
    { id: 2, person: 'partner', amount: 50000, frequency: 'yearly', growthRate: 2, startYear: 2026 }
  ];

  const expenses = [
    { id: 1, amount: 2500, frequency: 'monthly', startYear: 2026, adjustForInflation: true }
  ];

  const mortgage = {
    principal: 400000,
    interestRate: 3.5,
    mortgageType: 'annuity',
    durationYears: 30,
    startYear: new Date().getFullYear()
  };

  const [children, setChildren] = useState([]);

  const [assumptions] = useState({ inflationRate: 2, investmentReturn: 7 });
  const [netWorth, setNetWorth] = useState(20000);
  const [target] = useState(1500000);
  const [timeline, setTimeline] = useState(null);

  useEffect(() => {
    let nw = netWorth;
    const start = new Date().getFullYear();
    const rows = [];

    for (let y = start; y <= start + 50; y++) {
      const cf = calculateAnnualCashflow(
        y, incomes, expenses, assumptions, mortgage, householdType
      );

      const tax = calculateHouseholdTax({
        incomes, year: y, householdType, deductibleInterest: cf.deductibleInterest
      });

      const benefits = calculateNLBenefits({
        income: cf.income,
        householdType,
        childrenCount: children.length
      });

      const childcare = calculateChildcareBenefit({
        income: cf.income,
        children
      });

      const netSavings = cf.income - cf.expenses - tax + benefits + childcare;
      nw = nw * (1 + assumptions.investmentReturn / 100) + netSavings;

      rows.push({ year: y, netWorth: nw });
    }
    setTimeline(rows);
  }, [householdType, children]);

  return (
    <div className="max-w-4xl mx-auto p-6 space-y-6">
      <h1 className="text-2xl font-bold">Financiële planningstool</h1>

      <select
        value={householdType}
        onChange={e => setHouseholdType(e.target.value)}
        className="border px-2 py-1 rounded"
      >
        <option value="single">Alleenstaand</option>
        <option value="fiscal-partner">Fiscaal partner</option>
      </select>

      <NetWorthChart timeline={timeline} target={target} />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
